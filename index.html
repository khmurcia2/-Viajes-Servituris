
import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc } from 'firebase/firestore';

// --- Firebase Configuration and Initialization ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// URL for the uploaded logo. This URL is unique to the user's uploaded file.
const LOGO_URL = 'https://placehold.co/200x50/ffffff/000000?text=Viajes+Servituris';

// --- Main App Component ---
export default function App() {
  const [websiteContent, setWebsiteContent] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  // Estado para manejar qué categoría está seleccionada, si es nula, se muestran las categorías principales.
  const [selectedCategory, setSelectedCategory] = useState(null);

  // useEffect para manejar la autenticación y la carga inicial de datos
  useEffect(() => {
    const authenticate = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
        console.log("Authentication successful.");
      } catch (e) {
        console.error("Authentication error: ", e);
        setError("Error al autenticar. El sitio web puede no funcionar correctamente.");
      }
      setIsAuthReady(true);
    };

    authenticate();
  }, []);

  // useEffect para cargar el contenido de la base de datos
  useEffect(() => {
    if (!isAuthReady) {
      console.log("Waiting for authentication to be ready...");
      return;
    }
    
    const userId = auth.currentUser?.uid || 'anonymous';
    
    const contentDocRef = doc(db, `artifacts/${appId}/users/${userId}/websiteContent/main`);

    console.log("Listening to Firestore document at path:", contentDocRef.path);

    const unsubscribe = onSnapshot(contentDocRef, async (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        console.log("Document data found:", data);
        setWebsiteContent(data);
      } else {
        console.warn("Content document not found. Creating with default data.");
        const defaultContent = {
          logo: LOGO_URL,
          destinations: [
            {
              id: '1',
              title: 'Aventura y Naturaleza',
              text: 'Explora la selva, escala montañas o haz senderismo en los parques naturales más impresionantes.',
              imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Aventura',
              cities: [
                { id: 'c1', name: 'San Gil', description: 'Capital turística de Santander, ideal para deportes extremos.', imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=San+Gil' },
                { id: 'c2', name: 'Nuquí', description: 'Avistamiento de ballenas y playas vírgenes en el Pacífico colombiano.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Nuqui' }
              ]
            },
            {
              id: '2',
              title: 'Historia y Cultura',
              text: 'Sumérgete en el pasado visitando ciudades antiguas, museos y sitios arqueológicos.',
              imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Historia',
              cities: [
                { id: 'c3', name: 'Cartagena', description: 'Ciudad amurallada con una rica historia y arquitectura colonial.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Cartagena' },
                { id: 'c4', name: 'Villa de Leyva', description: 'Pueblo colonial con la plaza más grande de Colombia.', imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Villa+de+Leyva' }
              ]
            },
            {
              id: '3',
              title: 'Sol y Playa',
              text: 'Disfruta del paraíso tropical con playas de arena blanca, aguas cristalinas y un sol radiante.',
              imageUrl: 'https://placehold.co/600x400/ffffff/fe0000?text=Playa',
              cities: [
                { id: 'c5', name: 'Santa Marta', description: 'La perla del Caribe con playas paradisíacas y el Parque Tayrona.', imageUrl: 'https://placehold.co/600x400/ffffff/fe0000?text=Santa+Marta' },
                { id: 'c6', name: 'San Andrés', description: 'Mar de los siete colores, ideal para bucear y relajarse.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=San+Andres' },
                { id: 'c7', name: 'Taganga', description: 'Pueblo pesquero bohemio con excelentes playas.', imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Taganga' }
              ]
            },
            {
              id: '4',
              title: 'Compras y Lujo',
              text: 'Descubre las boutiques más exclusivas y los centros comerciales más grandes del mundo.',
              imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Compras',
              cities: [
                { id: 'c8', name: 'Bogotá', description: 'Capital de la moda y el lujo, con centros comerciales de alto nivel.', imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Bogota' },
                { id: 'c9', name: 'Medellín', description: 'Innovación y diseño, ideal para compras y moda de vanguardia.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Medellin' }
              ]
            },
            {
              id: '5',
              title: 'Gastronomía',
              text: 'Embárcate en un viaje culinario y deleita tu paladar con los sabores del mundo.',
              imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Gastronomia',
              cities: [
                { id: 'c10', name: 'Cali', description: 'Hogar de la salsa y una vibrante escena culinaria.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Cali' },
                { id: 'c11', name: 'Popayán', description: 'Conocida como la "Ciudad Blanca" por su arquitectura colonial.', imageUrl: 'https://placehold.co/600x400/fe0000/ffffff?text=Popayan' }
              ]
            },
            {
              id: '6',
              title: 'Relax y Bienestar',
              text: 'Relájate en spas de lujo y retiros de bienestar en destinos paradisíacos.',
              imageUrl: 'https://placehold.co/600x400/ffffff/fe0000?text=Relax',
              cities: [
                { id: 'c12', name: 'Eje Cafetero', description: 'Relájate en fincas cafeteras con aguas termales y vistas impresionantes.', imageUrl: 'https://placehold.co/600x400/ffffff/fe0000?text=Eje+Cafetero' },
                { id: 'c13', name: 'Termales de Santa Rosa', description: 'Aguas termales naturales en un entorno de montaña.', imageUrl: 'https://placehold.co/600x400/0446cb/ffffff?text=Santa+Rosa' }
              ]
            },
          ]
        };
        try {
          await setDoc(contentDocRef, defaultContent);
          console.log("Default document created successfully.");
        } catch (e) {
          console.error("Error creating default document:", e);
        }
        setWebsiteContent(defaultContent);
      }
      setLoading(false);
    }, (err) => {
      console.error("Error fetching data from Firestore: ", err);
      setError("No se pudieron cargar los datos del sitio web.");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, auth]);

  // Si aún se está cargando, se muestra un mensaje
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <p className="text-xl text-primary">Cargando...</p>
      </div>
    );
  }

  // Si hay un error, se muestra un mensaje de error
  if (error) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <p className="text-xl text-secondary">{error}</p>
      </div>
    );
  }

  const handleCategoryClick = (category) => {
    setSelectedCategory(category);
  };

  const handleBackClick = () => {
    setSelectedCategory(null);
  };
  
  // Renderizado de la aplicación
  return (
    <div className="bg-gray-100 min-h-screen font-sans">
      <style>{`
        /* Estilos personalizados para las fuentes y el fondo */
        body {
            font-family: 'Roboto', sans-serif;
        }

        .font-handlee {
            font-family: 'Handlee', cursive;
        }

        /* Colores de marca */
        .bg-primary {
            background-color: #0446cb;
        }

        .text-primary {
            color: #0446cb;
        }

        .bg-secondary {
            background-color: #fe0000;
        }

        .text-secondary {
            color: #fe0000;
        }

        .bg-white {
            background-color: #ffffff;
        }
        
        .btn-primary {
            @apply px-6 py-3 font-bold text-white bg-secondary rounded-full shadow-lg hover:bg-red-700 transition duration-300;
        }
      `}</style>

      {/* Sección de Navegación (Header) */}
      <header className="bg-white shadow-md sticky top-0 z-50">
        <nav className="container mx-auto px-6 py-4 flex justify-between items-center">
          <a href="#">
            {/* Conditional rendering for the logo: if the logo URL exists, show the image, otherwise show the text. */}
            {websiteContent.logo ? (
              <img src={websiteContent.logo} alt="Logo de Viajes Servituris" className="h-12 w-auto" />
            ) : (
              <h1 className="text-3xl font-bold font-handlee text-primary">Viajes Servituris</h1>
            )}
          </a>
          <ul className="hidden md:flex space-x-8">
            <li><a href="#about" className="text-gray-600 hover:text-primary transition duration-300">Nosotros</a></li>
            <li><a href="#destinations" className="text-gray-600 hover:text-primary transition duration-300">Destinos</a></li>
            <li><a href="#contact" className="text-gray-600 hover:text-primary transition duration-300">Contacto</a></li>
          </ul>
        </nav>
      </header>

      {/* Sección Principal (Hero) */}
      <main>
        <section className="bg-primary text-white py-24 text-center">
          <div className="container mx-auto px-6">
            <h1 className="font-handlee text-4xl sm:text-5xl md:text-6xl font-bold leading-tight mb-4">
              Tu Aventura Comienza Aquí
            </h1>
            <p className="text-xl sm:text-2xl mb-8">
              Descubre experiencias inolvidables, desde la aventura hasta el relax en el mar.
            </p>
            <a href="#destinations" className="btn-primary">
              Explora Ahora
            </a>
          </div>
        </section>

        {/* Sección Nosotros (About Us) */}
        <section id="about" className="bg-white py-16">
          <div className="container mx-auto px-6">
            <h2 className="text-4xl font-bold text-center text-primary mb-8">Nuestra Historia</h2>
            <div className="flex flex-col md:flex-row items-center justify-center space-y-8 md:space-y-0 md:space-x-12">
              <div className="w-full md:w-1/2 text-gray-700">
                <p className="mb-4">
                  En Viajes Servituris, creemos que cada viaje es una oportunidad para crear recuerdos inolvidables. Desde 1995, nos hemos dedicado a ofrecer experiencias de alta calidad que se adaptan a tus gustos, ya sea que busques la historia, la aventura o un tranquilo día de sol.
                </p>
                <p className="mb-4">
                  Nuestra misión es hacer de tus sueños de viaje una realidad, con un servicio personalizado y un equipo de expertos que te guiarán en cada paso del camino.
                </p>
                <a href="#contact" className="text-secondary hover:underline font-bold">¡Contáctanos y empieza a planear tu próximo viaje!</a>
              </div>
              <div className="w-full md:w-1/2">
                <img src="https://placehold.co/600x400/0446cb/ffffff?text=Viajes Servituris" alt="Imagen de nuestro equipo" className="rounded-lg shadow-lg" />
              </div>
            </div>
          </div>
        </section>

        {/* Sección de Destinos (Visual Gallery) */}
        <section id="destinations" className="py-16 bg-gray-100">
          <div className="container mx-auto px-6">
            {selectedCategory ? (
                // Muestra la lista de ciudades si una categoría está seleccionada
                <div className="flex flex-col items-center">
                    <button onClick={handleBackClick} className="btn-primary mb-8 self-start">
                        ← Volver a Categorías
                    </button>
                    <h2 className="text-4xl font-bold text-center text-primary mb-12">
                        {selectedCategory.title}
                    </h2>
                    <p className="text-lg text-center text-gray-600 mb-12">
                        {selectedCategory.text}
                    </p>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        {selectedCategory.cities.map(city => (
                            <div key={city.id} className="bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition duration-300">
                                <img src={city.imageUrl} alt={city.name} className="w-full h-48 object-cover" />
                                <div className="p-6">
                                    <h3 className="text-xl font-bold text-primary mb-2">{city.name}</h3>
                                    <p className="text-gray-600">{city.description}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            ) : (
                // Muestra la lista de categorías principales por defecto
                <>
                    <h2 className="text-4xl font-bold text-center text-primary mb-12">
                        Nuestros Destinos
                    </h2>
                    <p className="text-lg text-center text-gray-600 mb-12">
                        Te invitamos a explorar las experiencias que más te gustan.
                    </p>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        {websiteContent.destinations.map(destination => (
                            <div
                                key={destination.id}
                                onClick={() => handleCategoryClick(destination)}
                                className="bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition duration-300 cursor-pointer"
                            >
                                <img src={destination.imageUrl} alt={destination.title} className="w-full h-48 object-cover" />
                                <div className="p-6">
                                    <h3 className="text-xl font-bold text-primary mb-2">{destination.title}</h3>
                                    <p className="text-gray-600">{destination.text}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            )}
          </div>
        </section>

        {/* Sección de Contacto */}
        <section id="contact" className="bg-primary text-white py-16">
          <div className="container mx-auto px-6">
            <h2 className="text-4xl font-bold text-center mb-8">Contáctanos</h2>
            <p className="text-lg text-center mb-12">
              Déjanos tus datos y un asesor se pondrá en contacto contigo para planear tu próximo viaje.
            </p>
            <div className="max-w-xl mx-auto">
              <form className="space-y-6">
                <div>
                  <label htmlFor="name" className="block text-sm font-medium mb-1">Nombre</label>
                  <input type="text" id="name" name="name" className="w-full px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-secondary" required />
                </div>
                <div>
                  <label htmlFor="email" className="block text-sm font-medium mb-1">Correo electrónico</label>
                  <input type="email" id="email" name="email" className="w-full px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-secondary" required />
                </div>
                <div>
                  <label htmlFor="phone" className="block text-sm font-medium mb-1">Teléfono</label>
                  <input type="tel" id="phone" name="phone" className="w-full px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-secondary" />
                </div>
                <div>
                  <label htmlFor="message" className="block text-sm font-medium mb-1">Tu Mensaje</label>
                  <textarea id="message" name="message" rows="4" className="w-full px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-secondary" required />
                </div>
                <div className="text-center">
                  <button type="submit" className="btn-primary">
                    Enviar Mensaje
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>

      {/* Sección de Pie de página (Footer) */}
      <footer className="bg-gray-800 text-gray-300 py-8">
        <div className="container mx-auto px-6 text-center">
          <p>&copy; 2024 Viajes Servituris. Todos los derechos reservados.</p>
          <div className="mt-4 space-x-4">
            <a href="https://facebook.com/ViajesServiTuris" className="hover:text-white transition duration-300">Facebook</a>
            <a href="#" className="hover:text-white transition duration-300">Instagram</a>
            <a href="#" className="hover:text-white transition duration-300">TikTok</a>
          </div>
        </div>
      </footer>
    </div>
  );
}




